<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Matthew Maroney’s Site - Corolla Pricing with LASSO</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../images/personal_logo.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Matthew Maroney’s Site</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html" rel="" target="">
 <span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html" rel="" target="">
 <span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../resume.html" rel="" target="">
 <span class="menu-text">Resume</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/matthewmaroney" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#linear-regression" id="toc-linear-regression" class="nav-link active" data-scroll-target="#linear-regression">Linear Regression</a></li>
  <li><a href="#regularization" id="toc-regularization" class="nav-link" data-scroll-target="#regularization">Regularization</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Corolla Pricing with LASSO</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>The nonstandard R packages you will need to have installed and load for this document are all contained below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">repos =</span> <span class="fu">list</span>(<span class="at">CRAN=</span><span class="st">"http://cran.rstudio.com/"</span>))</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"tidyverse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
The downloaded binary packages are in
    /var/folders/v7/f2_6c0fn63xff0tsh5h3sdyr0000gn/T//RtmpQLAH3z/downloaded_packages</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dummy)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart.plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="linear-regression" class="level2">
<h2 class="anchored" data-anchor-id="linear-regression">Linear Regression</h2>
<p>A typical approach to prediction problems involves training a model that minimizes <em>deviance</em>. What is deviance? Well its essentially the pile of errors your model builds up over a sample. And while deviance takes different forms for different types of problems (like regression vs.&nbsp;classification), in regression problems the <em>sum of squared errors</em> (SSE) is commonly use as the <em>deviance</em> of the trained model from the observed outcomes in the data. For example, if we have a sample of 100 observations, then for each observation <span class="math inline">\(i\)</span>, we can view the actual outcome, <span class="math inline">\(y_i\)</span>. and compare it our model’s predicted outcome <span class="math inline">\(\hat{y_i}\)</span>, leading to an error <span class="math inline">\(e_i = y_i - \hat{y_i}\)</span> and squared error <span class="math inline">\(e_i2 = (y_i - \hat{y_i})\)</span>. We can then pile up all those 100 <span class="math inline">\(e^2\)</span>s to get a pile of errors. When a model generates a smaller pile of errors on a sample than another, then that model is doing a better job of prediction on that sample.</p>
<p>For a linear regression model we have a model that is formed by a simple equation. If we have <span class="math inline">\(k\)</span> predictors then our model can be expressed as,</p>
<p><span class="math display">\[
\begin{align}
\hat{y_i} &amp;= \hat{\beta_0} + \hat{\beta_1}x_{1i} + \hat{\beta_2}x_{2i} + \cdots + \hat{\beta_k}x_{ki} \nonumber \\
&amp;= \mathbf{x}_i'\hat{\boldsymbol{\beta}}
\end{align}
\]</span></p>
<p>where we have vectors, <span class="math inline">\(\mathbf{x}_i = [x_{1i}, x_{2i}, \cdots, x_{ki}]\)</span> and <span class="math inline">\(\hat{\boldsymbol{\beta}} = [\hat{\beta_0}, \hat{\beta_1}, \cdots, \hat{\beta_k}]\)</span>. For <span class="math inline">\(n\)</span> observations in a sample we are making predictions for, the deviance (or sum of squared errors - SSE) depends on the specific intercept and slopes we choose, i.e., which <span class="math inline">\(\hat{\boldsymbol{\beta}}\)</span>.</p>
<p><span class="math display">\[
\text{dev}\left(\hat{\boldsymbol{\beta}}\right) = \sum_{i=1}^{n} \left(y_i - \mathbf{x}_i \hat{\boldsymbol{\beta}} \right)^2
\]</span></p>
<p>We find the <span class="math inline">\(\hat{\boldsymbol{\beta}}\)</span> for a particular sample by figuring out which values of <span class="math inline">\(\hat{\boldsymbol{\beta}}\)</span> minimize deviance on that sample.</p>
<p>In predictive modeling, what we care most about is the model’s performance on new (future) data. When we calculate deviance on the data used for training we call it <em>in-sample deviance</em>. But what we really care about is <em>out-of-sample</em> (OOS) deviance. We approximate this the best we can by using data that wasn’t involved in the training process (i.e., test data, cross-validation error, etc.).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in the data and prep data types.</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>cars <span class="ot">=</span> <span class="fu">read_csv</span>(<span class="st">'ToyotaCorolla.csv'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>Id, <span class="sc">-</span>Model, <span class="sc">-</span>Mfg_Month, <span class="sc">-</span>Cylinders, <span class="sc">-</span>Quarterly_Tax) <span class="sc">%&gt;%</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Age =</span> Age_08_04) <span class="sc">%&gt;%</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="sc">-</span><span class="fu">one_of</span>(</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">'Price'</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">'Age'</span>,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">'KM'</span>,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">'HP'</span>,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">'CC'</span>,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">'Weight'</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  )), <span class="at">.funs =</span> factor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>My analysis: This data set, cars, tracks 87 variables over 1436 observations. It is tracking the price of Toyota Corollas based on a number of factors, so each variable is a different feature of the Corolla and each observation is a different Corolla. There is no missing data in this set so we do not need to make a plan to deal with that.</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(cars<span class="sc">$</span>Price)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Corolla-Pricing-with-LASSO_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><strong>My analysis: The Price variable looks alright for a linear regression. While the distribution does look right skewed, this is expected as not many Corollas would be dirt cheap (on the far left side of the distribution). The data does not have an excessive number of outliers.</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">featurePlot</span>(<span class="at">x =</span> cars<span class="sc">$</span>Age, </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> cars<span class="sc">$</span>Price, </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">plot =</span> <span class="st">"pairs"</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">auto.key =</span> <span class="fu">list</span>(<span class="at">columns =</span> <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Corolla-Pricing-with-LASSO_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">featurePlot</span>(<span class="at">x =</span> cars<span class="sc">$</span>KM, </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> cars<span class="sc">$</span>Price, </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">plot =</span> <span class="st">"pairs"</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">auto.key =</span> <span class="fu">list</span>(<span class="at">columns =</span> <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Corolla-Pricing-with-LASSO_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">featurePlot</span>(<span class="at">x =</span> cars<span class="sc">$</span>HP, </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> cars<span class="sc">$</span>Price, </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">plot =</span> <span class="st">"pairs"</span>,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">auto.key =</span> <span class="fu">list</span>(<span class="at">columns =</span> <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Corolla-Pricing-with-LASSO_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">featurePlot</span>(<span class="at">x =</span> cars<span class="sc">$</span>Weight, </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> cars<span class="sc">$</span>Price, </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">plot =</span> <span class="st">"pairs"</span>,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">auto.key =</span> <span class="fu">list</span>(<span class="at">columns =</span> <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Corolla-Pricing-with-LASSO_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">featurePlot</span>(<span class="at">x =</span> cars<span class="sc">$</span>CC, </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> cars<span class="sc">$</span>Price, </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">plot =</span> <span class="st">"pairs"</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">auto.key =</span> <span class="fu">list</span>(<span class="at">columns =</span> <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Corolla-Pricing-with-LASSO_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><strong>My analysis: Some of these variables do have a relationship with Price. Age and KM have the strongest relationship, both being strongly negative, and age being the stronger of the two. This is likely because age/level of use degrades the value of a car quickly. Additionally, as age increases, there are more new features on newer cars which make them more valuable. This occurs independent of the level of driving a car is put though, making age more reliable than just KM. Weight is another variable I tested which has a strong relationship, this one also negative.</strong></p>
<p><strong>My analysis: None of the relationships seem too strongly related. Some are not continuous and thus do not have real distributions but are also thus not too strongly correlated that they must be eliminated. None of the continuous variables appeared to correlate even closely to 1:1 with price, as can be observed in my featurePlots above.</strong></p>
<p>As a side note when building models with lots of categorical variables, you’ll want to often inspect how big these ‘groups’ are. For <code>Guarantee_Period</code>, there are several values, but we have periods 13, 18, 20, 24, 28, and 36 which each have 1 or 4 cars. This will create problems for us as models which rely on really rare categories. Especially if those categories are absent in future data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>cars <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Guarantee_Period) <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">table</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Guarantee_Period
   3    6   12   13   18   20   24   28   36 
1274   77   73    1    1    1    4    1    4 </code></pre>
</div>
</div>
<p>Based on the above, we will only want to include a few guarantee periods as dummies (3, 6, and 12).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all factors to dummy vars.</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>car_dum <span class="ot">=</span> <span class="fu">dummy</span>(cars, <span class="at">int =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>car_num <span class="ot">=</span> cars <span class="sc">%&gt;%</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">keep</span>(is.numeric)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>cars <span class="ot">=</span> <span class="fu">bind_cols</span>(car_num, car_dum)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(car_dum, car_num)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Partition the data.</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">5970</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>samp <span class="ot">=</span> <span class="fu">createDataPartition</span>(cars<span class="sc">$</span>Price, <span class="at">p =</span> <span class="fl">0.65</span>, <span class="at">list =</span> <span class="cn">FALSE</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>training <span class="ot">=</span> cars[samp, ]</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>testing <span class="ot">=</span> cars[<span class="sc">-</span>samp, ]</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(samp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For OLS remove one dummy from each categorical var</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>training_ols <span class="ot">=</span> training <span class="sc">%&gt;%</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>Mfg_Year_1998,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Fuel_Type_CNG,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Met_Color_0,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Color_Beige,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Automatic_0,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Doors_2,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Gears_3,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Mfr_Guarantee_0,</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>BOVAG_Guarantee_0,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Guarantee_Period_13,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Guarantee_Period_18,</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Guarantee_Period_20,</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Guarantee_Period_24,</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Guarantee_Period_28,</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Guarantee_Period_36,</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>ABS_0,</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Airbag_1_0,</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Airbag_2_0,</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Airco_0,</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Automatic_airco_0,</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Boardcomputer_0,</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>CD_Player_0,</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Central_Lock_0,</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Powered_Windows_0,</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Power_Steering_0,</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Radio_0,</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Mistlamps_0,</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Sport_Model_0,</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Backseat_Divider_0,</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Metallic_Rim_0,</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Radio_cassette_0,</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Parking_Assistant_0,</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>Tow_Bar_0</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>         )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train Ordinary Least Squares</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>ols1 <span class="ot">=</span> <span class="fu">lm</span>(Price <span class="sc">~</span> .,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> training_ols)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(ols1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        (Intercept)                 Age                  KM                  HP 
      -1.783214e+02       -3.716281e+01       -1.649201e-02        6.323544e+01 
                 CC              Weight       Mfg_Year_1999       Mfg_Year_2000 
      -4.461459e+00        1.095513e+01        6.297947e+02        1.346060e+03 
      Mfg_Year_2001       Mfg_Year_2002       Mfg_Year_2003       Mfg_Year_2004 
       1.949429e+03        3.861523e+03        5.279390e+03        7.096542e+03 
   Fuel_Type_Diesel    Fuel_Type_Petrol         Met_Color_1         Color_Black 
       4.489493e+03        7.269491e+02       -7.086229e+01        4.326831e+02 
         Color_Blue         Color_Green          Color_Grey           Color_Red 
       3.527251e+02        1.132329e+02        3.178587e+02        2.525654e+02 
       Color_Silver        Color_Violet         Color_White        Color_Yellow 
       2.079004e+02        3.199664e+02       -4.908328e+02        7.198950e+02 
        Automatic_1             Doors_3             Doors_4             Doors_5 
       6.023069e+02       -2.731599e+02       -9.138957e+01       -1.358638e+02 
            Gears_4             Gears_5             Gears_6     Mfr_Guarantee_1 
       1.806464e+02        7.349898e+02        5.179635e+02        2.959871e+02 
  BOVAG_Guarantee_1  Guarantee_Period_3  Guarantee_Period_6 Guarantee_Period_12 
       6.669424e+02       -1.390247e+03       -6.282641e+02       -4.791944e+02 
              ABS_1          Airbag_1_1          Airbag_2_1             Airco_1 
      -1.605311e+02        1.221752e+02        1.064131e+02        2.285296e+02 
  Automatic_airco_1     Boardcomputer_1         CD_Player_1      Central_Lock_1 
       1.635383e+03       -1.157608e+02        9.489124e+01        2.772641e+01 
  Powered_Windows_1    Power_Steering_1             Radio_1         Mistlamps_1 
       2.456190e+02       -3.703417e+02        6.842723e+02        1.586432e+02 
      Sport_Model_1  Backseat_Divider_1      Metallic_Rim_1    Radio_cassette_1 
      -3.947345e+01        2.597163e+02        1.044009e+02       -7.509118e+02 
Parking_Assistant_1           Tow_Bar_1 
      -6.610268e+02       -2.016919e+01 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># In-sample Deviance Measures</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>caret<span class="sc">::</span><span class="fu">postResample</span>(<span class="at">pred =</span> ols1<span class="sc">$</span>fitted.values,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">obs =</span> training_ols<span class="sc">$</span>Price)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        RMSE     Rsquared          MAE 
1007.4567322    0.9275498  741.6332747 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Out-of-sample Deviance Measures</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>caret<span class="sc">::</span><span class="fu">postResample</span>(<span class="at">pred =</span> <span class="fu">predict</span>(ols1, <span class="at">newdata =</span> testing),</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">obs =</span> testing<span class="sc">$</span>Price)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        RMSE     Rsquared          MAE 
3123.1904298    0.4571756  955.7421177 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>ols_rmse_test <span class="ot">=</span> <span class="fu">as.numeric</span>(caret<span class="sc">::</span><span class="fu">postResample</span>(<span class="at">pred =</span> <span class="fu">predict</span>(ols1, <span class="at">newdata =</span> testing),</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">obs =</span> testing<span class="sc">$</span>Price)[<span class="st">"RMSE"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="regularization" class="level2">
<h2 class="anchored" data-anchor-id="regularization">Regularization</h2>
<p>In settings where you have lots of features that you might include in your model, you need to be careful to select the best model for predicting <em>future</em> data and avoid overfit. How can we do this?</p>
<ol type="1">
<li>Use a “recipe” that provides a lot of good array of candidate models.</li>
<li>Then sort through the pile and select from among the candidates to minimize the error on new data.</li>
</ol>
<p>Behind the scenes that this means is changing the pile of errors (deviance) we are trying to minimize in a way that will <em>shrink</em> the coefficient (effect) a given feature can have on our model. If its coefficient is zero, for example <span class="math inline">\(\hat{\beta}_i = 0\)</span> , then it has no impact. If <span class="math inline">\(\hat{\beta_i} \neq 0\)</span> then the model has some effect and the further from zero a coefficient is, the bigger its impact on the model. Bigger impacts can lead to better predictions when its a true signal, but lead to bigger errors when the relationship is noise!!! So our goal is to let coefficients on real signals grow carefully, while shrinking coefficients on noise to zero. We accomplish this by measuring the size of <span class="math inline">\(\hat{\boldsymbol{\beta}}\)</span> in addition to its effect on deviance. In other words we now want to choose values for <span class="math inline">\(\hat{\boldsymbol{\beta}}\)</span> so as to minmize</p>
<p><span class="math display">\[
\text{dev}\left(\hat{\boldsymbol{\beta}}\right) + \lambda \cdot \text{L1Norm}\left(\hat{\boldsymbol{\beta}}\right)
\]</span></p>
<p>where <span class="math inline">\(\text{L1Norm()}\)</span> is the “size” of our coefficients <span class="math inline">\(\hat{\boldsymbol{\beta}}\)</span> and this term is mathematically determined. The number <span class="math inline">\(\lambda\)</span> is a penalty or the “price” we charge ourselves for letting <span class="math inline">\(\hat{\boldsymbol{\beta}}\)</span> get too big. But this number is not pre-determined. It is a <em>hyperparameter</em> that we have to choose before doing a minimization problem.</p>
<ul>
<li><p>As <span class="math inline">\(\lambda\)</span> gets larger we want to shrink the size of <span class="math inline">\(\hat{\boldsymbol{\beta}}\)</span> so that we have fewer nonzero coefficients (making the model more sparse) and the nonzero ones are closer to zero.</p></li>
<li><p>As <span class="math inline">\(\lambda\)</span> gets smaller we want to allow the size of <span class="math inline">\(\hat{\boldsymbol{\beta}}\)</span> to grow meaning coefficients get bigger and</p></li>
</ul>
<p>Any value of <span class="math inline">\(\lambda\)</span> we choose will have an impact on the coefficients learned from the data, which affects our predictions. Each value of <span class="math inline">\(\lambda\)</span> we choose can be referred to as a regularization path. Again if <span class="math inline">\(\lambda\)</span> is a price, then each price we set gives us a different prediction/error capacity. Instead of choosing just one value and hoping for the best, we can solve the problem and calculate different vector of coefficients <span class="math inline">\(\hat{\boldsymbol{\beta}}\)</span> for each value of <span class="math inline">\(\lambda\)</span>. By default, the <code>glmnet</code> package will calculate coefficients for each of 100 different <span class="math inline">\(\lambda\)</span> penalty values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>X <span class="ot">=</span> <span class="fu">as.matrix</span>(<span class="fu">select</span>(training, <span class="sc">-</span>Price))</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> training<span class="sc">$</span>Price</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>lasso_fit <span class="ot">=</span> <span class="fu">glmnet</span>(X, y)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(lasso_fit, <span class="st">"lambda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Corolla-Pricing-with-LASSO_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The plot above shows the model results over different <span class="math inline">\(\lambda\)</span> values. Imagine 100 vertical slices (represeneted by x-axis values) for different choices of <span class="math inline">\(\lambda\)</span>. The lines in the graph represent the values (sizes) of coefficients for potential features in our model. At each x-axis value, you can see which features have nonzero coefficients and how big or small some may be. As we go right, the value of <span class="math inline">\(\lambda\)</span> increases until all coefficients shrink to zero and the model is extremely sparse. Low values of <span class="math inline">\(\lambda\)</span> are on the left, where most all features have larger, non-zero coefficients and our model is quite large.</p>
<p>We can look at the model that results from any one regularization path by choosing a <span class="math inline">\(\lambda\)</span> value to look at. You’ll see higher values lead to sparse models, lower values lead to complex models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(lasso_fit, <span class="at">s =</span> <span class="fu">exp</span>(<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>87 x 1 sparse Matrix of class "dgCMatrix"
                               s1
(Intercept)          4.569550e+03
Age                 -5.502178e+01
KM                  -1.632840e-02
HP                   5.296258e+01
CC                  -3.421634e+00
Weight               1.168093e+01
Mfg_Year_1998       -8.616763e+02
Mfg_Year_1999       -4.503567e+02
Mfg_Year_2000        .           
Mfg_Year_2001        3.376733e+02
Mfg_Year_2002        2.049235e+03
Mfg_Year_2003        3.230824e+03
Mfg_Year_2004        4.960007e+03
Fuel_Type_CNG       -7.388063e+02
Fuel_Type_Diesel     2.887021e+03
Fuel_Type_Petrol     .           
Met_Color_0          4.043266e+01
Met_Color_1         -1.071960e+01
Color_Beige         -2.650599e+02
Color_Black          1.285332e+02
Color_Blue           6.423893e+01
Color_Green         -1.140338e+02
Color_Grey           5.470243e+01
Color_Red           -1.537235e-01
Color_Silver        -1.500026e+00
Color_Violet         .           
Color_White         -7.112599e+02
Color_Yellow         3.273754e+02
Automatic_0         -5.078627e+02
Automatic_1          1.587488e-09
Doors_2              7.085292e+01
Doors_3             -1.018097e+02
Doors_4              .           
Doors_5              .           
Gears_3             -6.610477e+02
Gears_4             -1.743563e+02
Gears_5              7.379914e+01
Gears_6              .           
Mfr_Guarantee_0     -2.865842e+02
Mfr_Guarantee_1      .           
BOVAG_Guarantee_0   -4.354167e+02
BOVAG_Guarantee_1    1.631778e+02
Guarantee_Period_3  -6.391368e+02
Guarantee_Period_6   .           
Guarantee_Period_12  1.804401e+02
Guarantee_Period_13  .           
Guarantee_Period_18  .           
Guarantee_Period_20  1.233762e+03
Guarantee_Period_24  7.821458e+02
Guarantee_Period_28  1.402703e+03
Guarantee_Period_36 -4.871054e+02
ABS_0                8.412695e+01
ABS_1               -4.069281e-10
Airbag_1_0          -1.953724e+01
Airbag_1_1           .           
Airbag_2_0          -5.088188e+01
Airbag_2_1           3.275354e-10
Airco_0             -2.110072e+02
Airco_1              .           
Automatic_airco_0   -1.668244e+03
Automatic_airco_1    .           
Boardcomputer_0      .           
Boardcomputer_1      .           
CD_Player_0         -1.230678e+02
CD_Player_1          .           
Central_Lock_0      -6.151745e+01
Central_Lock_1       .           
Powered_Windows_0   -1.834397e+02
Powered_Windows_1    .           
Power_Steering_0     1.981174e+02
Power_Steering_1     .           
Radio_0              .           
Radio_1              .           
Mistlamps_0         -1.452774e+02
Mistlamps_1          2.644046e-10
Sport_Model_0        2.989354e+01
Sport_Model_1       -2.805791e-10
Backseat_Divider_0  -1.788242e+02
Backseat_Divider_1   5.401914e-10
Metallic_Rim_0      -8.248562e+01
Metallic_Rim_1       .           
Radio_cassette_0     5.188823e+01
Radio_cassette_1     .           
Parking_Assistant_0  5.192945e+02
Parking_Assistant_1 -9.986572e-09
Tow_Bar_0            1.649845e+01
Tow_Bar_1           -2.683281e-10</code></pre>
</div>
</div>
<p>Which path is best for prediction? We can compare performance on the training data vs the testing data over all regularization paths and also compare to our OLS “kitchen sink” model in which we just added everything without regularization.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>logLambda <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">8</span>, <span class="fl">0.1</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>testing_mat <span class="ot">=</span> <span class="fu">as.matrix</span>(testing)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>RMSE_train <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>RMSE_test <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> logLambda) {</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  train_i <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">postResample</span>(<span class="at">pred=</span><span class="fu">predict</span>(lasso_fit, X, <span class="at">s=</span><span class="fu">exp</span>(i)), <span class="at">obs=</span>y)[<span class="st">"RMSE"</span>])</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  RMSE_train <span class="ot">=</span> <span class="fu">append</span>(RMSE_train, train_i)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  test_i <span class="ot">=</span> <span class="fu">postResample</span>(<span class="at">pred=</span><span class="fu">predict</span>(lasso_fit, testing_mat[,<span class="dv">2</span><span class="sc">:</span><span class="dv">87</span>], <span class="at">s=</span><span class="fu">exp</span>(i)), <span class="at">obs=</span>testing_mat[,<span class="dv">1</span>])[<span class="st">"RMSE"</span>]</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  RMSE_test <span class="ot">=</span> <span class="fu">append</span>(RMSE_test, <span class="fu">as.numeric</span>(test_i))</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x =</span> logLambda, <span class="at">y =</span> RMSE_train, <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col =</span> <span class="st">"blue"</span>,</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"RMSE Deviance over Lambda: Train vs Test"</span>,</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Log Lambda"</span>,</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">"RMSE Deviance"</span>)</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> logLambda, <span class="at">y =</span> RMSE_test, <span class="at">col=</span><span class="st">"red"</span>, <span class="at">lw=</span><span class="dv">2</span>)</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span>ols_rmse_test, <span class="at">col=</span><span class="st">"black"</span>)</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="fl">3.25</span>, <span class="dv">2700</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"LASSO Training"</span>, <span class="st">"LASSO Testing"</span>, <span class="st">"OLS Testing"</span>), <span class="at">fill=</span><span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"red"</span>, <span class="st">"black"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Corolla-Pricing-with-LASSO_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Cross-validated Choice of <span class="math inline">\(\lambda\)</span></p>
<p>But what value of <span class="math inline">\(\lambda\)</span> do we choose to get the best model? From above we’d like to minimize deviance/error on new future data. Our test data gives us an indication of where this might be. We can use cross-validation to check each value of <span class="math inline">\(\lambda\)</span> and find the one that gives us minimum or near-minimum error on hold-out data. This is our best guess as to performance on new future data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>cv_lasso <span class="ot">=</span> <span class="fu">cv.glmnet</span>(X, y, <span class="at">type.measure =</span> <span class="st">"mse"</span>, <span class="at">nfolds=</span><span class="dv">20</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cv_lasso)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Corolla-Pricing-with-LASSO_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(cv_lasso, <span class="at">s =</span> <span class="st">"lambda.min"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>87 x 1 sparse Matrix of class "dgCMatrix"
                               s1
(Intercept)          2.039867e+03
Age                 -9.268330e+01
KM                  -1.576064e-02
HP                   1.957395e+01
CC                   .           
Weight               1.408500e+01
Mfg_Year_1998        .           
Mfg_Year_1999        .           
Mfg_Year_2000        .           
Mfg_Year_2001        .           
Mfg_Year_2002        1.201695e+03
Mfg_Year_2003        1.850921e+03
Mfg_Year_2004        3.198377e+03
Fuel_Type_CNG       -5.172226e+02
Fuel_Type_Diesel     .           
Fuel_Type_Petrol     .           
Met_Color_0          .           
Met_Color_1          .           
Color_Beige          .           
Color_Black          .           
Color_Blue           .           
Color_Green         -7.267889e+00
Color_Grey           .           
Color_Red            .           
Color_Silver         .           
Color_Violet         .           
Color_White         -4.444337e+02
Color_Yellow         .           
Automatic_0         -4.333903e+01
Automatic_1          1.852730e-11
Doors_2              .           
Doors_3              .           
Doors_4              .           
Doors_5              .           
Gears_3              .           
Gears_4              .           
Gears_5              .           
Gears_6              .           
Mfr_Guarantee_0     -2.072237e+02
Mfr_Guarantee_1      .           
BOVAG_Guarantee_0   -3.708453e+02
BOVAG_Guarantee_1    4.353313e+01
Guarantee_Period_3  -2.726044e+02
Guarantee_Period_6   .           
Guarantee_Period_12  1.143311e+02
Guarantee_Period_13  .           
Guarantee_Period_18  .           
Guarantee_Period_20  .           
Guarantee_Period_24  .           
Guarantee_Period_28  .           
Guarantee_Period_36  .           
ABS_0                .           
ABS_1                .           
Airbag_1_0           .           
Airbag_1_1           .           
Airbag_2_0           .           
Airbag_2_1           .           
Airco_0             -1.220682e+02
Airco_1              .           
Automatic_airco_0   -1.795574e+03
Automatic_airco_1    .           
Boardcomputer_0      .           
Boardcomputer_1      .           
CD_Player_0         -6.766796e+01
CD_Player_1          .           
Central_Lock_0      -7.473071e+01
Central_Lock_1       .           
Powered_Windows_0   -8.656770e+01
Powered_Windows_1    .           
Power_Steering_0     .           
Power_Steering_1     .           
Radio_0              .           
Radio_1              .           
Mistlamps_0         -1.100573e+02
Mistlamps_1          2.767985e-11
Sport_Model_0        .           
Sport_Model_1        .           
Backseat_Divider_0   .           
Backseat_Divider_1   .           
Metallic_Rim_0      -1.450066e+01
Metallic_Rim_1       .           
Radio_cassette_0     .           
Radio_cassette_1     .           
Parking_Assistant_0  .           
Parking_Assistant_1  .           
Tow_Bar_0            .           
Tow_Bar_1            .           </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(cv_lasso, <span class="at">s =</span> <span class="st">"lambda.1se"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>87 x 1 sparse Matrix of class "dgCMatrix"
                               s1
(Intercept)          2.747413e+03
Age                 -1.006359e+02
KM                  -1.530218e-02
HP                   1.754265e+01
CC                   .           
Weight               1.374312e+01
Mfg_Year_1998        .           
Mfg_Year_1999        .           
Mfg_Year_2000        .           
Mfg_Year_2001        .           
Mfg_Year_2002        6.275309e+02
Mfg_Year_2003        1.161437e+03
Mfg_Year_2004        2.094682e+03
Fuel_Type_CNG        .           
Fuel_Type_Diesel     .           
Fuel_Type_Petrol     .           
Met_Color_0          .           
Met_Color_1          .           
Color_Beige          .           
Color_Black          .           
Color_Blue           .           
Color_Green          .           
Color_Grey           .           
Color_Red            .           
Color_Silver         .           
Color_Violet         .           
Color_White          .           
Color_Yellow         .           
Automatic_0          .           
Automatic_1          .           
Doors_2              .           
Doors_3              .           
Doors_4              .           
Doors_5              .           
Gears_3              .           
Gears_4              .           
Gears_5              .           
Gears_6              .           
Mfr_Guarantee_0     -8.108338e+01
Mfr_Guarantee_1      .           
BOVAG_Guarantee_0   -7.355626e+01
BOVAG_Guarantee_1    .           
Guarantee_Period_3   .           
Guarantee_Period_6   .           
Guarantee_Period_12  .           
Guarantee_Period_13  .           
Guarantee_Period_18  .           
Guarantee_Period_20  .           
Guarantee_Period_24  .           
Guarantee_Period_28  .           
Guarantee_Period_36  .           
ABS_0                .           
ABS_1                .           
Airbag_1_0           .           
Airbag_1_1           .           
Airbag_2_0           .           
Airbag_2_1           .           
Airco_0             -5.937139e+01
Airco_1              .           
Automatic_airco_0   -1.977027e+03
Automatic_airco_1    .           
Boardcomputer_0      .           
Boardcomputer_1      .           
CD_Player_0          .           
CD_Player_1          .           
Central_Lock_0      -4.789938e+01
Central_Lock_1       .           
Powered_Windows_0   -9.564883e+01
Powered_Windows_1    .           
Power_Steering_0     .           
Power_Steering_1     .           
Radio_0              .           
Radio_1              .           
Mistlamps_0          .           
Mistlamps_1          .           
Sport_Model_0        .           
Sport_Model_1        .           
Backseat_Divider_0   .           
Backseat_Divider_1   .           
Metallic_Rim_0       .           
Metallic_Rim_1       .           
Radio_cassette_0     .           
Radio_cassette_1     .           
Parking_Assistant_0  .           
Parking_Assistant_1  .           
Tow_Bar_0            .           
Tow_Bar_1            .           </code></pre>
</div>
</div>
<p>Compare to OLS</p>
<p>Finally, lets see what this regularization process has yielded us. We first fit a plain OLS model with all variables, something that might likely lead to overfitting and including lots of noise. Overall prediction was not that great. Lets see how much better we do on the test data with regularization and cross-validation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>ols_res <span class="ot">=</span> <span class="fu">postResample</span>(<span class="at">pred=</span><span class="fu">predict</span>(ols1, testing), <span class="at">obs=</span>testing<span class="sc">$</span>Price)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(ols_res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        RMSE     Rsquared          MAE 
3123.1904298    0.4571756  955.7421177 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>cvlasso_res <span class="ot">=</span> <span class="fu">postResample</span>(<span class="at">pred=</span><span class="fu">predict</span>(cv_lasso, testing_mat[,<span class="dv">2</span><span class="sc">:</span><span class="dv">87</span>], <span class="at">s=</span><span class="st">"lambda.min"</span>),</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">obs=</span>testing_mat[,<span class="dv">1</span>])</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(cvlasso_res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        RMSE     Rsquared          MAE 
1144.9031848    0.8868547  851.6820741 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>cvlasso_rmse <span class="ot">=</span> <span class="fu">as.numeric</span>(cvlasso_res[<span class="st">"RMSE"</span>])</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">paste0</span>(<span class="st">"Regularization reduced RMSE on test data by: "</span>, <span class="fu">round</span>((ols_rmse_test<span class="sc">-</span>cvlasso_rmse)<span class="sc">/</span>ols_rmse_test<span class="sc">*</span><span class="dv">100</span>,<span class="dv">2</span>), <span class="st">"%"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Regularization reduced RMSE on test data by: 63.34%"</code></pre>
</div>
</div>
<p><strong>My analysis: After regularization, my model is effective for predicting the price of Corollas for CorollaCrowd. Identifying and removing variables which caused overfitting in the model reduced RMSE by 63.34% and increased the Rsquared, the extent to which the variables in the model explain the variation in the data, by ~43%. This means our model is much more effective at capturing and using important variables to determine a given Corolla’s value. The model is not perfect - the Rsquared of the regularized model is still only 89%, meaning it does not explain over 10% of the variation in the data. This means, though, that our model is a generally good predictor.</strong></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>